#!/usr/bin/env python
#
# See top-level LICENSE.rst file for Copyright information
#
# -*- coding: utf-8 -*-

"""
Run one or more pipeline steps.
"""

from __future__ import absolute_import, division, print_function

comm = None
rank = 0
nproc = 1

try:
    from mpi4py import MPI
    comm = MPI.COMM_WORLD
    rank = comm.rank
    nproc = comm.size
except ImportError:
    print("mpi4py not found, using only one process")

import sys
import os
import numpy as np
import argparse
import re

from desispec.log import get_logger
import desispec.pipeline as pipe


def main():
    parser = argparse.ArgumentParser( description='Run steps of the pipeline at a given concurrency.' )
    parser.add_argument( '--night', required=False, default=None, help='only use process this night (YYYYMMDD)' )
    parser.add_argument( '--first', required=False, default=None, help='first step of the pipeline to run' )
    parser.add_argument( '--last', required=False, default=None, help='last step of the pipeline to run')
    args = parser.parse_args()

    log = get_logger()


    # raw and production locations

    rawdir = os.environ['DESI_SPECTRO_DATA']
    proddir = os.path.join(os.environ['DESI_SPECTRO_REDUX'], os.environ['PRODNAME'])

    if rank == 0:
        log.info("using raw dir {}".format(rawdir))
        log.info("using spectro production dir {}".format(proddir))

    # run it!

    pipe.run_steps(args.first, args.last, rawdir, proddir, nights=[args.night], comm=comm)


if __name__ == "__main__":
    main()

